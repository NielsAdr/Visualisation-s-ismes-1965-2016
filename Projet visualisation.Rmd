---
title: "leaflet"
author: "Niels"
date: "2022-11-18"
output: html_document
---
```{r}
require(dplyr)
require(stringr)
require(leaflet)

data <- read.table('earthquake.csv', sep = ',', dec = '.', header = TRUE)
data$Date <- substr(x= data$Date, start = 7, stop = 10)
```

```{r}
data <- data %>%
  mutate(dangerosite= case_when(Magnitude <= 6 ~ 'Grand séisme ≤ 6',
                           Magnitude <= 6.9 ~ 'Très grand séisme ≤ 6,9',
                           Magnitude <= 7.9 ~ 'Séisme majeur ≤ 7,9',
                           Magnitude <= 8.9 ~ 'Séisme énorme ≤ 8,9',
                           Magnitude > 8.9 ~ 'Séisme énorme et rare > 8.9')) %>%
  mutate(dangerosite = factor(dangerosite,
                        levels = c('Grand séisme ≤ 6', 'Très grand séisme ≤ 6,9',
                                   'Séisme majeur ≤ 7,9', 'Séisme énorme ≤ 8,9', 'Séisme énorme et rare > 8.9'))) 
```

```{r}
data$Date <- as.factor(data$Date)
data$Type <- as.factor(data$Type)
data$Magnitude.Type <- as.factor(data$Magnitude.Type)
data <- data %>% filter(Magnitude.Type != '')
data <- data %>% filter(Type == 'Earthquake') # Nous ne voulons visualiser que les tremblements de terre
data_clean <- data[-c(7383,20468),c(1,3,4,5,6,9,22)]
summary(data_clean)
```

```{r}
dbTectonic <- read.csv("tectonic.csv", sep=";")
dbTectonic$lat = as.numeric(dbTectonic$lat)
dbTectonic$lon = as.numeric(dbTectonic$lon)
dbTectonic$plate = str_to_upper(dbTectonic$plate)

map = leaflet(data_clean) %>% addProviderTiles("Esri.WorldImagery")
plates = dbTectonic$plate %>% unique() 

for (plate1 in plates){ #For each plate
  data = dbTectonic[(dbTectonic$plate == plate1),] %>% unique() 
  BorneInf = 0
  for (i in 1:nrow(data)){
    if(i + 1 <= nrow(data)){
      if(abs(data$lon[i]-data$lon[i + 1])>300){
        table1 = data %>% slice((BorneInf + 1):i)
        BorneInf = i
        map = map %>% 
          addPolylines(data = table1, lat = ~lat,lng =~lon,weight = 2,color = "black")
        
      }
    }
  }
  table1 = data %>%  slice((BorneInf + 1):nrow(data))
  map = map %>% addPolylines(data = table1, lat = ~lat,lng =~lon,weight = 2,color = "black")
}

map
```

```{r}
pal <- colorFactor(c("#fad453","yellow","#e65000","red","#5a213e"), domain = NULL)

label <- paste(
  "Depth: ", data_clean$Depth, "<br/>",
  "Magnitude: ", data_clean$Magnitude, "<br/>",
  "Année: ", data_clean$Date, "<br/>") %>%
  lapply(htmltools::HTML)

map %>% addCircleMarkers(~Longitude,~Latitude,
  fillColor = ~pal(dangerosite),
  stroke = FALSE, fillOpacity = ~Magnitude/10,
  radius = ~(exp(Magnitude/4)),
  label = label
) %>%
  addLegend (pal = pal, values = ~dangerosite, title = "Dangerosité", position = "bottomright")
```

